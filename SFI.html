<?xml version="1.0" encoding="utf-8"?>
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-10-06 Tue 23:22 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SFI</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="ST-Saint" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.cacheClassElem = elem.className;
         elem.cacheClassTarget = target.className;
         target.className = "code-highlighted";
         elem.className   = "code-highlighted";
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(elem.cacheClassElem)
         elem.className = elem.cacheClassElem;
       if(elem.cacheClassTarget)
         target.className = elem.cacheClassTarget;
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">SFI</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org7dd6781">1. Prerequisites</a>
<ul>
<li><a href="#org40e6564">1.1. linux cross platform</a></li>
<li><a href="#org35fa9b0">1.2. Bionic-Builder</a></li>
</ul>
</li>
<li><a href="#orgf6b100f">2. BUGS</a>
<ul>
<li><a href="#orga2a53c3">2.1. linux-v5.9</a>
<ul>
<li><a href="#org3811a38">2.1.1. <span class="todo HOLD">HOLD</span> 注册 watchpoint 之后马上被触发</a></li>
</ul>
</li>
<li><a href="#org77e27a7">2.2. netlink</a>
<ul>
<li><a href="#org199ac02">2.2.1. <span class="todo TODO">TODO</span> 普通用户权限传递给 netlink kernel</a></li>
</ul>
</li>
<li><a href="#org2b5c3c1">2.3. watchpoint</a></li>
</ul>
</li>
<li><a href="#orgc631717">3. UNDO</a>
<ul>
<li><a href="#org045a6a8">3.1. system call</a></li>
<li><a href="#orge0741bd">3.2. thread 切换</a>
<ul>
<li><a href="#org586e927">3.2.1. option</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org65f17b9">4. commands</a>
<ul>
<li><a href="#org4199d3a">4.1. linux cross compile</a></li>
<li><a href="#org0e2dafd">4.2. network</a></li>
</ul>
</li>
<li><a href="#org4b10283">5. <span class="done DONE">DONE</span> USB Serial Debug</a>
<ul>
<li><a href="#org901e768">5.1. <code>[1/1]</code> issue</a>
<ul>
<li><a href="#orga9ac95c">5.1.1. <span class="done DONE">DONE</span> ttyACM 无法输入</a></li>
</ul>
</li>
<li><a href="#org6c166bb">5.2. 串口调试</a></li>
</ul>
</li>
<li><a href="#orgb6b2e2d">6. <span class="done DONE">DONE</span> register hw\<sub>breakpoint</sub> linux work flow</a>
<ul>
<li><a href="#org0c59065">6.1. <code>linux-5.8/kernel/events/hw_breakpoint.c *register_wide_hw_breakpoint*</code></a></li>
<li><a href="#orgd7d008c">6.2. <code>linux-5.8/kernel/events/core.c *perf_event_create_kernel_counter*</code></a></li>
<li><a href="#org8e19641">6.3. <code>linux-5.8/kernel/events/core.c *perf_event_alloc*</code></a></li>
<li><a href="#orgd6bf4d3">6.4. <code>*perf_init_event*</code></a></li>
<li><a href="#org1f06f7f">6.5. hw\<sub>breakpoin</sub> info parse</a></li>
<li><a href="#org0f11851">6.6. install hw breakpoint</a></li>
</ul>
</li>
<li><a href="#orgf695b99">7. arch\<sub>hw</sub>\<sub>breakpoint</sub> struct</a>
<ul>
<li><a href="#orgd181618">7.1. arch\<sub>hw</sub>\<sub>breakpoint</sub></a></li>
</ul>
</li>
<li><a href="#org6d8f9f4">8. DBG registers</a>
<ul>
<li><a href="#org9031f4f">8.1. DBGBCR&lt;n&gt;<sub>EL1</sub></a></li>
<li><a href="#orgb7e630d">8.2. DBGBVR&lt;n&gt;<sub>EL1</sub></a></li>
<li><a href="#org19003db">8.3. DBGWCR&lt;n&gt;<sub>EL1</sub></a></li>
</ul>
</li>
<li><a href="#org0cd6906">9. <span class="done DONE">DONE</span> 修改 BCR, BVR 寄存器</a></li>
</ul>
</div>
</div>

<div id="outline-container-org7dd6781" class="outline-2">
<h2 id="org7dd6781"><span class="section-number-2">1</span> Prerequisites</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org40e6564" class="outline-3">
<h3 id="org40e6564"><span class="section-number-3">1.1</span> linux cross platform</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ECBE7B;">sudo</span> apt-get install gcc-aarch64-linux-gnu
</pre>
</div>
</div>
</div>
<div id="outline-container-org35fa9b0" class="outline-3">
<h3 id="org35fa9b0"><span class="section-number-3">1.2</span> Bionic-Builder</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ECBE7B;">sudo</span> apt-get install -y ccache python-pip build-essential kernel-package fakeroot libncurses5-dev libssl-dev gcc  git-core gnupg binfmt-support qemu qemu-user-static debootstrap simg2img
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf6b100f" class="outline-2">
<h2 id="orgf6b100f"><span class="section-number-2">2</span> BUGS</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orga2a53c3" class="outline-3">
<h3 id="orga2a53c3"><span class="section-number-3">2.1</span> linux-v5.9</h3>
<div class="outline-text-3" id="text-2-1">
</div>
<div id="outline-container-org3811a38" class="outline-4">
<h4 id="org3811a38"><span class="section-number-4">2.1.1</span> <span class="todo HOLD">HOLD</span> 注册 watchpoint 之后马上被触发</h4>
<div class="outline-text-4" id="text-2-1-1">
<p>
可能是堆地址
</p>
</div>
</div>
</div>

<div id="outline-container-org77e27a7" class="outline-3">
<h3 id="org77e27a7"><span class="section-number-3">2.2</span> netlink</h3>
<div class="outline-text-3" id="text-2-2">
</div>
<div id="outline-container-org199ac02" class="outline-4">
<h4 id="org199ac02"><span class="section-number-4">2.2.1</span> <span class="todo TODO">TODO</span> 普通用户权限传递给 netlink kernel</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
普通用户无法注册 watchpoint
sudo 权限可注册
</p>

<ul class="org-ul">
<li>可用于保护 watchpoint 不被恶意使用</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org2b5c3c1" class="outline-3">
<h3 id="org2b5c3c1"><span class="section-number-3">2.3</span> watchpoint</h3>
<div class="outline-text-3" id="text-2-3">
<p>
触发之后无法跳出 trigger function
</p>

<p>
<a href="https://stackoverflow.com/questions/28280813/register-wide-hw-breakpoint-continually-triggers-handler-callback">feature</a>
</p>
</div>
</div>
</div>

<div id="outline-container-orgc631717" class="outline-2">
<h2 id="orgc631717"><span class="section-number-2">3</span> UNDO</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org045a6a8" class="outline-3">
<h3 id="org045a6a8"><span class="section-number-3">3.1</span> system call</h3>
<div class="outline-text-3" id="text-3-1">
<p>
<a href="https://www.kernel.org/doc/html/latest/process/adding-syscalls.html">system call linux kernel docs</a>
</p>
</div>
</div>
<div id="outline-container-orge0741bd" class="outline-3">
<h3 id="orge0741bd"><span class="section-number-3">3.2</span> thread 切换</h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-org586e927" class="outline-4">
<h4 id="org586e927"><span class="section-number-4">3.2.1</span> option</h4>
<div class="outline-text-4" id="text-3-2-1">
<ul class="org-ul">
<li>每个线程自己拥有自己的 breakpoint info, 线程切换时 unregister, register
<ol class="org-ol">
<li>增加可用 watchpoint 数量</li>
<li>overhead</li>
<li>加锁位置?</li>
</ol></li>

<li>所用进程共用 watchpoint, 切换时设置 disable
<ol class="org-ol">
<li>数量有限</li>
<li>效率</li>
</ol></li>
</ul>
</div>
</div>
</div>
</div>


<div id="outline-container-org65f17b9" class="outline-2">
<h2 id="org65f17b9"><span class="section-number-2">4</span> commands</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org4199d3a" class="outline-3">
<h3 id="org4199d3a"><span class="section-number-3">4.1</span> linux cross compile</h3>
<div class="outline-text-3" id="text-4-1">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ECBE7B;">sudo</span> <span style="color: #ECBE7B;">make</span> -j20 <span style="color: #dcaeea;">ARCH</span>=arm64 <span style="color: #dcaeea;">CROSS_COMPILE</span>=aarch64-linux-gnu- hikey970_defconfig
<span style="color: #ECBE7B;">sudo</span> <span style="color: #ECBE7B;">make</span> -j20 <span style="color: #dcaeea;">ARCH</span>=arm64 <span style="color: #dcaeea;">CROSS_COMPILE</span>=aarch64-linux-gnu- all
</pre>
</div>
</div>
</div>
<div id="outline-container-org0e2dafd" class="outline-3">
<h3 id="org0e2dafd"><span class="section-number-3">4.2</span> network</h3>
<div class="outline-text-3" id="text-4-2">
<ul class="org-ul">
<li><p>
connect wifi from terminal
</p>

<div class="org-src-container">
<pre class="src src-bash">  <span style="color: #ECBE7B;">sudo</span> nmcli dev wifi connect <span style="color: #98be65;">'SSID'</span>
</pre>
</div></li>

<li><p>
control
</p>
<div class="org-src-container">
<pre class="src src-bash"> <span style="color: #ECBE7B;">sudo</span> nmcli
</pre>
</div></li>
</ul>
</div>
</div>
</div>


<div id="outline-container-org4b10283" class="outline-2">
<h2 id="org4b10283"><span class="section-number-2">5</span> <span class="done DONE">DONE</span> USB Serial Debug</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org901e768" class="outline-3">
<h3 id="org901e768"><span class="section-number-3">5.1</span> <code>[1/1]</code> issue</h3>
<div class="outline-text-3" id="text-5-1">
</div>
<div id="outline-container-orga9ac95c" class="outline-4">
<h4 id="orga9ac95c"><span class="section-number-4">5.1.1</span> <span class="done DONE">DONE</span> ttyACM 无法输入</h4>
<div class="outline-text-4" id="text-5-1-1">
<p>
<a href="https://discuss.96boards.org/t/how-to-connect-to-console-in-hikey970-in-android/5484/10">XR21V1410 USB-UART</a>
</p>

<blockquote>
<p>
Hikey970 uses XR21B14 chip for the USB-C debug serial port. The driver for this chip is not available in upstream linux kernel but since it supports part of USB CDC class, it does appear as ttyACM0 port. But this chip uses custom flow control modes which can’t be supported by usb cdc driver and flow control is needed for input. That’s why you can’t type anything onto the default ttyACM0 console but you can see the output.
</p>

<p>
Coming to your question on some people got it working fully, that is mainly due to the packaging of specific driver for this chip in the distro version. For instance, Ubuntu 18.04 has this driver enabled, so users who have this specific distro will be able to use it without any issues. They will have the console as ttyXRUSB0 instead of ttyACM0.
</p>

<p>
So if you need to use this port, please build the driver(just google xr21b14 driver, you’ll find it) and load onto your PC.
</p>
</blockquote>


<p>
<a href="https://www.maxlinear.com/support/design-tools/software-drivers">XR21V1410 Driver</a>
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ECBE7B;">sudo</span> rmmod cdc_acm
<span style="color: #ECBE7B;">sudo</span> insmod xr_sub_serial_common.ko
</pre>
</div>

<p>
重新插拔 Type-C USB, hikey970 被识别为 <code>ttyXRUSB</code>
</p>
</div>
</div>
</div>

<div id="outline-container-org6c166bb" class="outline-3">
<h3 id="org6c166bb"><span class="section-number-3">5.2</span> 串口调试</h3>
<div class="outline-text-3" id="text-5-2">
<ul class="org-ul">
<li>minicom 115200 8N1</li>
<li><b>hardware / software flow control: No</b></li>
</ul>
</div>
</div>
</div>


<div id="outline-container-orgb6b2e2d" class="outline-2">
<h2 id="orgb6b2e2d"><span class="section-number-2">6</span> <span class="done DONE">DONE</span> register hw\<sub>breakpoint</sub> linux work flow</h2>
<div class="outline-text-2" id="text-6">
</div>

<div id="outline-container-org0c59065" class="outline-3">
<h3 id="org0c59065"><span class="section-number-3">6.1</span> <code>linux-5.8/kernel/events/hw_breakpoint.c *register_wide_hw_breakpoint*</code></h3>
<div class="outline-text-3" id="text-6-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #83898d;">/**</span>
<span style="color: #83898d;"> * register_wide_hw_breakpoint - register a wide breakpoint in the kernel</span>
<span style="color: #83898d;"> * </span><span style="color: #a9a1e1;">@attr</span><span style="color: #83898d;">: breakpoint attributes</span>
<span style="color: #83898d;"> * </span><span style="color: #a9a1e1;">@triggered</span><span style="color: #83898d;">: callback to trigger when we hit the breakpoint</span>
<span style="color: #83898d;"> *</span>
<span style="color: #83898d;"> * </span><span style="color: #a9a1e1;">@return</span><span style="color: #83898d;"> a set of per_cpu pointers to perf events</span>
<span style="color: #83898d;"> */</span>

<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> * <span style="color: #c678dd;">__percpu</span> *
register_wide_hw_breakpoint<span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event_attr</span> *<span style="color: #dcaeea;">attr</span>,
                <span style="color: #ECBE7B;">perf_overflow_handler_t</span> <span style="color: #dcaeea;">triggered</span>,
                <span style="color: #ECBE7B;">void</span> *<span style="color: #dcaeea;">context</span><span style="color: #51afef;">)</span>;

...<span style="color: #da8548; font-weight: bold;">571</span>
        bp = perf_event_create_kernel_counter<span style="color: #51afef;">(</span>attr, cpu, <span style="color: #a9a1e1;">NULL</span>,
                              triggered, context<span style="color: #51afef;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd7d008c" class="outline-3">
<h3 id="orgd7d008c"><span class="section-number-3">6.2</span> <code>linux-5.8/kernel/events/core.c *perf_event_create_kernel_counter*</code></h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">
<pre class="src src-c"> <span style="color: #83898d;">/**</span>
<span style="color: #83898d;"> * perf_event_create_kernel_counter</span>
<span style="color: #83898d;"> *</span>
<span style="color: #83898d;"> * </span><span style="color: #a9a1e1;">@attr</span><span style="color: #83898d;">: attributes of the counter to create</span>
<span style="color: #83898d;"> * </span><span style="color: #a9a1e1;">@cpu</span><span style="color: #83898d;">: cpu in which the counter is bound</span>
<span style="color: #83898d;"> * </span><span style="color: #a9a1e1;">@task</span><span style="color: #83898d;">: task to profile (NULL for percpu)</span>
<span style="color: #83898d;"> */</span>
<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *
<span style="color: #c678dd;">perf_event_create_kernel_counter</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event_attr</span> *<span style="color: #dcaeea;">attr</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">cpu</span>,
                 <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">task_struct</span> *<span style="color: #dcaeea;">task</span>,
                 <span style="color: #ECBE7B;">perf_overflow_handler_t</span> <span style="color: #dcaeea;">overflow_handler</span>,
                 <span style="color: #ECBE7B;">void</span> *<span style="color: #dcaeea;">context</span><span style="color: #51afef;">)</span>;
...<span style="color: #da8548; font-weight: bold;">11952</span>
    event = perf_event_alloc<span style="color: #51afef;">(</span>attr, cpu, task, <span style="color: #a9a1e1;">NULL</span>, <span style="color: #a9a1e1;">NULL</span>,
                 overflow_handler, context, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org8e19641" class="outline-3">
<h3 id="org8e19641"><span class="section-number-3">6.3</span> <code>linux-5.8/kernel/events/core.c *perf_event_alloc*</code></h3>
<div class="outline-text-3" id="text-6-3">
<div class="org-src-container">
<pre class="src src-c"> <span style="color: #5B6268;">/*</span>
<span style="color: #5B6268;"> * Allocate and initialize an event structure</span>
<span style="color: #5B6268;"> </span><span style="color: #5B6268;">*/</span>
<span style="color: #51afef;">static</span> <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *
<span style="color: #c678dd;">perf_event_alloc</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event_attr</span> *<span style="color: #dcaeea;">attr</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">cpu</span>,
                 <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">task_struct</span> *<span style="color: #dcaeea;">task</span>,
                 <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *<span style="color: #dcaeea;">group_leader</span>,
                 <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *<span style="color: #dcaeea;">parent_event</span>,
                 <span style="color: #ECBE7B;">perf_overflow_handler_t</span> <span style="color: #dcaeea;">overflow_handler</span>,
                 <span style="color: #ECBE7B;">void</span> *<span style="color: #dcaeea;">context</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">cgroup_fd</span><span style="color: #51afef;">)</span>

...<span style="color: #da8548; font-weight: bold;">11035</span>
    event-&gt;cpu      = cpu;
    event-&gt;attr     = *attr;
    event-&gt;group_leader = group_leader;
    event-&gt;pmu      = <span style="color: #a9a1e1;">NULL</span>;
    event-&gt;oncpu        = -<span style="color: #da8548; font-weight: bold;">1</span>;

    event-&gt;parent       = parent_event;

    event-&gt;ns       = get_pid_ns<span style="color: #51afef;">(</span>task_active_pid_ns<span style="color: #c678dd;">(</span>current<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>;
    event-&gt;id       = atomic64_inc_return<span style="color: #51afef;">(</span>&amp;perf_event_id<span style="color: #51afef;">)</span>;

...<span style="color: #da8548; font-weight: bold;">11110</span>
    pmu = perf_init_event<span style="color: #51afef;">(</span>event<span style="color: #51afef;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd6bf4d3" class="outline-3">
<h3 id="orgd6bf4d3"><span class="section-number-3">6.4</span> <code>*perf_init_event*</code></h3>
<div class="outline-text-3" id="text-6-4">
<ul class="org-ul">
<li>perf\<sub>init</sub>\<sub>event</sub></li>
</ul>

<div class="org-src-container">
<pre class="src src-c">
<span style="color: #51afef;">static</span> <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">pmu</span> *<span style="color: #c678dd;">perf_init_event</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *<span style="color: #dcaeea;">event</span><span style="color: #51afef;">)</span>
        ret = perf_try_init_event<span style="color: #51afef;">(</span>pmu, event<span style="color: #51afef;">)</span>;
</pre>
</div>

<p>
call <code>*pmu.event_init(event)*</code>
</p>

<p>
&#x2026;
</p>

<ul class="org-ul">
<li><code>linux-5.8/kernel/events/hw_breakpoint.c</code></li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #51afef;">static</span> <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">pmu</span> <span style="color: #dcaeea;">perf_breakpoint</span> = <span style="color: #51afef;">{</span>
    .task_ctx_nr    = perf_sw_context, <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">could eventually get its own </span><span style="color: #5B6268;">*/</span>

    .event_init = hw_breakpoint_event_init,
    .add            = hw_breakpoint_add,
    .del            = hw_breakpoint_del,
    .start      = hw_breakpoint_start,
    .stop       = hw_breakpoint_stop,
    .read       = hw_breakpoint_pmu_read,
<span style="color: #51afef;">}</span>;

</pre>
</div>

<ul class="org-ul">
<li><code>*hw_breakpoint_event_init*</code></li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #51afef;">static</span> <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">hw_breakpoint_event_init</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *<span style="color: #dcaeea;">bp</span><span style="color: #51afef;">)</span>
<span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">err</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>bp-&gt;attr.type != <span style="color: #a9a1e1;">PERF_TYPE_BREAKPOINT</span><span style="color: #c678dd;">)</span>
        <span style="color: #51afef;">return</span> -<span style="color: #a9a1e1;">ENOENT</span>;

    <span style="color: #5B6268;">/*</span>
<span style="color: #5B6268;">     * no branch sampling for breakpoint events</span>
<span style="color: #5B6268;">     </span><span style="color: #5B6268;">*/</span>
    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>has_branch_stack<span style="color: #98be65;">(</span>bp<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>
        <span style="color: #51afef;">return</span> -<span style="color: #a9a1e1;">EOPNOTSUPP</span>;

    err = register_perf_hw_breakpoint<span style="color: #c678dd;">(</span>bp<span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>err<span style="color: #c678dd;">)</span>
        <span style="color: #51afef;">return</span> err;

    bp-&gt;destroy = bp_perf_event_destroy;

    <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #51afef;">}</span>
</pre>
</div>

<ul class="org-ul">
<li><code>*register_perf_hw_breakpoint*</code></li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">register_perf_hw_breakpoint</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *<span style="color: #dcaeea;">bp</span><span style="color: #51afef;">)</span>
<span style="color: #51afef;">{</span>
    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">arch_hw_breakpoint</span> <span style="color: #dcaeea;">hw</span> = <span style="color: #c678dd;">{</span> <span style="color: #c678dd;">}</span>;
    <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">err</span>;

    err = reserve_bp_slot<span style="color: #c678dd;">(</span>bp<span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>err<span style="color: #c678dd;">)</span>
        <span style="color: #51afef;">return</span> err;

    err = hw_breakpoint_parse<span style="color: #c678dd;">(</span>bp, &amp;bp-&gt;attr, &amp;hw<span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>err<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
        release_bp_slot<span style="color: #98be65;">(</span>bp<span style="color: #98be65;">)</span>;
        <span style="color: #51afef;">return</span> err;
    <span style="color: #c678dd;">}</span>

    bp-&gt;hw.info = hw;

    <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #51afef;">}</span>
</pre>
</div>

<p>
reserve / release 加锁
</p>

<ul class="org-ul">
<li><code>*hw_breakpoint_parse*</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #51afef;">static</span> <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">hw_breakpoint_parse</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *<span style="color: #dcaeea;">bp</span>,
                   <span style="color: #51afef;">const</span> <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event_attr</span> *<span style="color: #dcaeea;">attr</span>,
                   <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">arch_hw_breakpoint</span> *<span style="color: #dcaeea;">hw</span><span style="color: #51afef;">)</span>
<span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">err</span>;

    err = hw_breakpoint_arch_parse<span style="color: #c678dd;">(</span>bp, attr, hw<span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>err<span style="color: #c678dd;">)</span>
        <span style="color: #51afef;">return</span> err;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>arch_check_bp_in_kernelspace<span style="color: #98be65;">(</span>hw<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
        <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>attr-&gt;exclude_kernel<span style="color: #98be65;">)</span>
            <span style="color: #51afef;">return</span> -<span style="color: #a9a1e1;">EINVAL</span>;
        <span style="color: #5B6268;">/*</span>
<span style="color: #5B6268;">         * Don't let unprivileged users set a breakpoint in the trap</span>
<span style="color: #5B6268;">         * path to avoid trap recursion attacks.</span>
<span style="color: #5B6268;">         </span><span style="color: #5B6268;">*/</span>
        <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span><span style="color: #51afef; font-weight: bold;">!</span>capable<span style="color: #51afef;">(</span><span style="color: #a9a1e1;">CAP_SYS_ADMIN</span><span style="color: #51afef;">)</span><span style="color: #98be65;">)</span>
            <span style="color: #51afef;">return</span> -<span style="color: #a9a1e1;">EPERM</span>;
    <span style="color: #c678dd;">}</span>

    <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #51afef;">}</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
<code>*hw_breakpoint_arch_parse*</code>
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #5B6268;">/*</span>
<span style="color: #5B6268;"> * Validate the arch-specific HW Breakpoint register settings.</span>
<span style="color: #5B6268;"> </span><span style="color: #5B6268;">*/</span>
<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">hw_breakpoint_arch_parse</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *<span style="color: #dcaeea;">bp</span>,
                 <span style="color: #51afef;">const</span> <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event_attr</span> *<span style="color: #dcaeea;">attr</span>,
                 <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">arch_hw_breakpoint</span> *<span style="color: #dcaeea;">hw</span><span style="color: #51afef;">)</span>
<span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">ret</span>;
    <span style="color: #ECBE7B;">u64</span> <span style="color: #dcaeea;">alignment_mask</span>, <span style="color: #dcaeea;">offset</span>;

    <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Build the arch_hw_breakpoint. </span><span style="color: #5B6268;">*/</span>
    ret = arch_build_bp_info<span style="color: #c678dd;">(</span>bp, attr, hw<span style="color: #c678dd;">)</span>;
...
<span style="color: #51afef;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org1f06f7f" class="outline-3">
<h3 id="org1f06f7f"><span class="section-number-3">6.5</span> hw\<sub>breakpoin</sub> info parse</h3>
<div class="outline-text-3" id="text-6-5">
<ul class="org-ul">
<li><p>
<code>arch_build_bp_info</code>
</p>

<p>
解析 <code>perf_even-&gt;hw-&gt;info</code>
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org0f11851" class="outline-3">
<h3 id="org0f11851"><span class="section-number-3">6.6</span> install hw breakpoint</h3>
<div class="outline-text-3" id="text-6-6">
<ul class="org-ul">
<li><code>*hw_breakpoint_add*</code></li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #51afef;">static</span> <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">hw_breakpoint_add</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *<span style="color: #dcaeea;">bp</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">flags</span><span style="color: #51afef;">)</span>
<span style="color: #51afef;">{</span>
    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span><span style="color: #51afef; font-weight: bold;">!</span><span style="color: #98be65;">(</span>flags &amp; <span style="color: #a9a1e1;">PERF_EF_START</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>
        bp-&gt;hw.state = <span style="color: #a9a1e1;">PERF_HES_STOPPED</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>is_sampling_event<span style="color: #98be65;">(</span>bp<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
        bp-&gt;hw.last_period = bp-&gt;hw.sample_period;
        perf_swevent_set_period<span style="color: #98be65;">(</span>bp<span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>

    <span style="color: #51afef;">return</span> arch_install_hw_breakpoint<span style="color: #c678dd;">(</span>bp<span style="color: #c678dd;">)</span>;
<span style="color: #51afef;">}</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
<code>linux-5.8/arch/arm64/kernel/hw_breakpoint.c *arch_install_hw_breakpoint*</code>
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #5B6268;">/*</span>
<span style="color: #5B6268;"> * Install a perf counter breakpoint.</span>
<span style="color: #5B6268;"> </span><span style="color: #5B6268;">*/</span>
<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">arch_install_hw_breakpoint</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *<span style="color: #dcaeea;">bp</span><span style="color: #51afef;">)</span>
<span style="color: #51afef;">{</span>
    <span style="color: #51afef;">return</span> hw_breakpoint_control<span style="color: #c678dd;">(</span>bp, <span style="color: #a9a1e1;">HW_BREAKPOINT_INSTALL</span><span style="color: #c678dd;">)</span>;
<span style="color: #51afef;">}</span>

</pre>
</div></li>

<li><code>linux-5.8/arch/arm64/kernel/hw_breakpoint.c *hw_breakpoint_control*</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #51afef;">static</span> <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">hw_breakpoint_control</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *<span style="color: #dcaeea;">bp</span>,
                 <span style="color: #51afef;">enum</span> <span style="color: #ECBE7B;">hw_breakpoint_ops</span> <span style="color: #dcaeea;">ops</span><span style="color: #51afef;">)</span>
<span style="color: #51afef;">{</span>
    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">arch_hw_breakpoint</span> *<span style="color: #dcaeea;">info</span> = counter_arch_bp<span style="color: #c678dd;">(</span>bp<span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> **<span style="color: #dcaeea;">slots</span>;
    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">debug_info</span> *<span style="color: #dcaeea;">debug_info</span> = &amp;current-&gt;thread.debug;
    <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span>, <span style="color: #dcaeea;">max_slots</span>, <span style="color: #dcaeea;">ctrl_reg</span>, <span style="color: #dcaeea;">val_reg</span>, <span style="color: #dcaeea;">reg_enable</span>;
    <span style="color: #51afef;">enum</span> <span style="color: #ECBE7B;">dbg_active_el</span> <span style="color: #dcaeea;">dbg_el</span> = debug_exception_level<span style="color: #c678dd;">(</span>info-&gt;ctrl.privilege<span style="color: #c678dd;">)</span>;
    <span style="color: #ECBE7B;">u32</span> <span style="color: #dcaeea;">ctrl</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>info-&gt;ctrl.type == <span style="color: #a9a1e1;">ARM_BREAKPOINT_EXECUTE</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
        <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Breakpoint </span><span style="color: #5B6268;">*/</span>
        ctrl_reg = AARCH64_DBG_REG_BCR;
        val_reg = AARCH64_DBG_REG_BVR;
        slots = this_cpu_ptr<span style="color: #98be65;">(</span>bp_on_reg<span style="color: #98be65;">)</span>;
        max_slots = core_num_brps;
        reg_enable = <span style="color: #51afef; font-weight: bold;">!</span>debug_info-&gt;bps_disabled;
    <span style="color: #c678dd;">}</span> <span style="color: #51afef;">else</span> <span style="color: #c678dd;">{</span>
        <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Watchpoint </span><span style="color: #5B6268;">*/</span>
        ctrl_reg = AARCH64_DBG_REG_WCR;
        val_reg = AARCH64_DBG_REG_WVR;
        slots = this_cpu_ptr<span style="color: #98be65;">(</span>wp_on_reg<span style="color: #98be65;">)</span>;
        max_slots = core_num_wrps;
        reg_enable = <span style="color: #51afef; font-weight: bold;">!</span>debug_info-&gt;wps_disabled;
    <span style="color: #c678dd;">}</span>

    i = hw_breakpoint_slot_setup<span style="color: #c678dd;">(</span>slots, max_slots, bp, ops<span style="color: #c678dd;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span><span style="color: #a9a1e1;">WARN_ONCE</span><span style="color: #98be65;">(</span>i &lt; <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #98be65;">"Can't find any breakpoint slot"</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>
        <span style="color: #51afef;">return</span> i;

    <span style="color: #51afef;">switch</span> <span style="color: #c678dd;">(</span>ops<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">case</span> <span style="color: #a9a1e1;">HW_BREAKPOINT_INSTALL</span>:
        <span style="color: #5B6268;">/*</span>
<span style="color: #5B6268;">         * Ensure debug monitors are enabled at the correct exception</span>
<span style="color: #5B6268;">         * level.</span>
<span style="color: #5B6268;">         </span><span style="color: #5B6268;">*/</span>
        enable_debug_monitors<span style="color: #98be65;">(</span>dbg_el<span style="color: #98be65;">)</span>;
        fallthrough;
    <span style="color: #51afef;">case</span> <span style="color: #a9a1e1;">HW_BREAKPOINT_RESTORE</span>:
        <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Setup the address register. </span><span style="color: #5B6268;">*/</span>
        write_wb_reg<span style="color: #98be65;">(</span>val_reg, i, info-&gt;address<span style="color: #98be65;">)</span>;

        <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Setup the control register. </span><span style="color: #5B6268;">*/</span>
        ctrl = encode_ctrl_reg<span style="color: #98be65;">(</span>info-&gt;ctrl<span style="color: #98be65;">)</span>;
        write_wb_reg<span style="color: #98be65;">(</span>ctrl_reg, i,
                 reg_enable ? ctrl | <span style="color: #da8548; font-weight: bold;">0x1</span> : ctrl &amp; ~<span style="color: #da8548; font-weight: bold;">0x1</span><span style="color: #98be65;">)</span>;
        <span style="color: #51afef;">break</span>;
    <span style="color: #51afef;">case</span> <span style="color: #a9a1e1;">HW_BREAKPOINT_UNINSTALL</span>:
        <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Reset the control register. </span><span style="color: #5B6268;">*/</span>
        write_wb_reg<span style="color: #98be65;">(</span>ctrl_reg, i, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">)</span>;

        <span style="color: #5B6268;">/*</span>
<span style="color: #5B6268;">         * Release the debug monitors for the correct exception</span>
<span style="color: #5B6268;">         * level.</span>
<span style="color: #5B6268;">         </span><span style="color: #5B6268;">*/</span>
        disable_debug_monitors<span style="color: #98be65;">(</span>dbg_el<span style="color: #98be65;">)</span>;
        <span style="color: #51afef;">break</span>;
    <span style="color: #c678dd;">}</span>

    <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #51afef;">}</span>
</pre>
</div>
</div>
</div>
</div>



<div id="outline-container-orgf695b99" class="outline-2">
<h2 id="orgf695b99"><span class="section-number-2">7</span> arch\<sub>hw</sub>\<sub>breakpoint</sub> struct</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-orgd181618" class="outline-3">
<h3 id="orgd181618"><span class="section-number-3">7.1</span> arch\<sub>hw</sub>\<sub>breakpoint</sub></h3>
<div class="outline-text-3" id="text-7-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">hw_perf_event</span> <span style="color: #51afef;">{</span>
    ...;
    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">hw_perf_event</span>        <span style="color: #dcaeea;">hw</span>;
    ...;
<span style="color: #51afef;">}</span>

<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">hw_petf_event</span><span style="color: #51afef;">{</span>
    ...;
    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">arch_hw_breakpoint</span> <span style="color: #dcaeea;">info</span>;
    ...;
<span style="color: #51afef;">}</span>

<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">arch_hw_breakpoint</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">u64</span> <span style="color: #dcaeea;">address</span>;
    <span style="color: #ECBE7B;">u64</span> <span style="color: #dcaeea;">trigger</span>;
    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">arch_hw_breakpoint_ctrl</span> <span style="color: #dcaeea;">ctrl</span>;
<span style="color: #51afef;">}</span>;

<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">arch_hw_breakpoint_ctrl</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">u32</span> <span style="color: #dcaeea;">__reserved</span>  : <span style="color: #da8548; font-weight: bold;">19</span>,
    <span style="color: #dcaeea;">len</span>     : <span style="color: #da8548; font-weight: bold;">8</span>,
    <span style="color: #dcaeea;">type</span>        : <span style="color: #da8548; font-weight: bold;">2</span>,
    <span style="color: #dcaeea;">privilege</span>   : <span style="color: #da8548; font-weight: bold;">2</span>,
    <span style="color: #dcaeea;">enabled</span>     : <span style="color: #da8548; font-weight: bold;">1</span>;
<span style="color: #51afef;">}</span>;
</pre>
</div>

<p>
arch\<sub>hw</sub>\<sub>breakpoint</sub>-&gt;ctrl 位域实现 DBGWCR
</p>
</div>
</div>
</div>

<div id="outline-container-org6d8f9f4" class="outline-2">
<h2 id="org6d8f9f4"><span class="section-number-2">8</span> DBG registers</h2>
<div class="outline-text-2" id="text-8">
</div>
<div id="outline-container-org9031f4f" class="outline-3">
<h3 id="org9031f4f"><span class="section-number-3">8.1</span> DBGBCR&lt;n&gt;<sub>EL1</sub></h3>
<div class="outline-text-3" id="text-8-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">bits [63:24]</th>
<th scope="col" class="org-left">BT, bits [23:20]</th>
<th scope="col" class="org-left">LBN, bits [19:16]</th>
<th scope="col" class="org-left">SSC, bits [15:14]</th>
<th scope="col" class="org-left">HMC, bit [13]</th>
<th scope="col" class="org-left">Bits [12:9]</th>
<th scope="col" class="org-left">BAS, bits [8:5]</th>
<th scope="col" class="org-left">Bits [4:3]</th>
<th scope="col" class="org-left">PMC, bits [2:1]</th>
<th scope="col" class="org-left">E, bit [0]</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Reserved</td>
<td class="org-left">Breakpoint Type</td>
<td class="org-left">Linked breakpoint number</td>
<td class="org-left">Security state control</td>
<td class="org-left">Higher mode control.</td>
<td class="org-left">Reserved</td>
<td class="org-left">Byte address select.</td>
<td class="org-left">Reserved</td>
<td class="org-left">Privilege mode control</td>
<td class="org-left">Enable breakpoint</td>
</tr>
</tbody>
</table>

<p>
DBGBCR&lt;n&gt;<sub>EL1.BT</sub> shoulde be 0b000x
</p>
</div>
</div>
<div id="outline-container-orgb7e630d" class="outline-3">
<h3 id="orgb7e630d"><span class="section-number-3">8.2</span> DBGBVR&lt;n&gt;<sub>EL1</sub></h3>
<div class="outline-text-3" id="text-8-2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">RESS[14:4], bits [63:53]</th>
<th scope="col" class="org-left">VA[52:49], bits [52:49]</th>
<th scope="col" class="org-left">VA[48:2], bits [48:2]</th>
<th scope="col" class="org-left">Bits [1:0]</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Reserved</td>
<td class="org-left">Extension to VA[48:2]</td>
<td class="org-left">the address value for comparison</td>
<td class="org-left">Reserved</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org19003db" class="outline-3">
<h3 id="org19003db"><span class="section-number-3">8.3</span> DBGWCR&lt;n&gt;<sub>EL1</sub></h3>
<div class="outline-text-3" id="text-8-3">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Bits [63:29]</th>
<th scope="col" class="org-left">Bits [23:21]</th>
<th scope="col" class="org-left">WT, bit [20]</th>
<th scope="col" class="org-left">LBN, bits [19:16]</th>
<th scope="col" class="org-left">SSC, bits [15:14]</th>
<th scope="col" class="org-left">HMC, bit [13]</th>
<th scope="col" class="org-left">BAS, bits [12:5]</th>
<th scope="col" class="org-left">LSC, bits [4:3]</th>
<th scope="col" class="org-left">PAC, bits [2:1]</th>
<th scope="col" class="org-left">E, bit [0]</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Reserved</td>
<td class="org-left">Reserved</td>
<td class="org-left">Address mask</td>
<td class="org-left">Linked breakpoint number</td>
<td class="org-left">Security state control</td>
<td class="org-left">Higher mode control</td>
<td class="org-left">Byte address select</td>
<td class="org-left">Load/store control</td>
<td class="org-left">Privilege of access control</td>
<td class="org-left">Enable</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><code>linked data address</code>
在特定 <code>context</code> 触发</li>

<li>WT
0b0 unlinked data address</li>

<li>LBN
0b0000</li>

<li>SSC</li>

<li>HMC</li>

<li>BAS</li>

<li>LSC
save load control</li>
</ul>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">LSC</td>
<td class="org-left">Meaning</td>
</tr>

<tr>
<td class="org-left">0b01</td>
<td class="org-left">Match           instructions that load from a watchpointed address.</td>
</tr>

<tr>
<td class="org-left">0b10</td>
<td class="org-left">Match           instructions that store to a watchpointed address.</td>
</tr>

<tr>
<td class="org-left">0b11</td>
<td class="org-left">Match           instructions that load from or store to a watchpointed address.</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>PAC</li>

<li>E
0 disabled
1 enabled</li>
</ul>
</div>
</div>
</div>


<div id="outline-container-org0cd6906" class="outline-2">
<h2 id="org0cd6906"><span class="section-number-2">9</span> <span class="done DONE">DONE</span> 修改 BCR, BVR 寄存器</h2>
<div class="outline-text-2" id="text-9">
<ul class="org-ul">
<li>ref <a href="https://developer.arm.com/docs/ddi0595/h/aarch64-system-registers/dbgbcrn_el1">DBGBCR</a></li>

<li><p>
code
</p>
<div class="org-src-container">
<pre class="src src-c">    <span style="color: #51afef;">case</span> <span style="color: #a9a1e1;">HW_BREAKPOINT_RESTORE</span>:
        <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Setup the address register. </span><span style="color: #5B6268;">*/</span>
        <span style="color: #c678dd;">write_wb_reg</span><span style="color: #51afef;">(</span>val_reg, i, info-&gt;address<span style="color: #51afef;">)</span>;

        <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Setup the control register. </span><span style="color: #5B6268;">*/</span>
        ctrl = encode_ctrl_reg<span style="color: #51afef;">(</span>info-&gt;ctrl<span style="color: #51afef;">)</span>;
        <span style="color: #c678dd;">write_wb_reg</span><span style="color: #51afef;">(</span>ctrl_reg, i,
                 reg_enable ? ctrl | <span style="color: #da8548; font-weight: bold;">0x1</span> : ctrl &amp; ~<span style="color: #da8548; font-weight: bold;">0x1</span><span style="color: #51afef;">)</span>;
        <span style="color: #51afef;">break</span>;
</pre>
</div></li>
</ul>
<p>
[[<a href="file:///home/saint/Bionic-Builder/Kernel-SRC/linux/arch/arm64/kernel/hw_breakpoint.c#MissingReference">file:///home/saint/Bionic-Builder/Kernel-SRC/linux/arch/arm64/kernel/hw_breakpoint.c#MissingReference</a> HW<sub>BREAKPOINT</sub><sub>RESTORE</sub>:
</p>

<p>
<a href="#org1f06f7f">hw\<sub>breakpoin</sub> info parse</a>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: ST-Saint</p>
<p class="date">Created: 2020-10-06 Tue 23:22</p>
</div>
</body>
</html>
