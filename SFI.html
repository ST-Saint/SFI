<?xml version="1.0" encoding="utf-8"?>
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-10-17 Sat 13:00 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SFI</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="ST-Saint" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.cacheClassElem = elem.className;
         elem.cacheClassTarget = target.className;
         target.className = "code-highlighted";
         elem.className   = "code-highlighted";
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(elem.cacheClassElem)
         elem.className = elem.cacheClassElem;
       if(elem.cacheClassTarget)
         target.className = elem.cacheClassTarget;
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">SFI</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org8d2e68d">1. Prerequisites</a>
<ul>
<li><a href="#org2a72bc0">1.1. linux cross platform</a></li>
<li><a href="#orgfd1a5d6">1.2. Bionic-Builder</a></li>
</ul>
</li>
<li><a href="#orge5489ea">2. <code>[3/5]</code> BUGS</a>
<ul>
<li><a href="#org62f673a">2.1. <span class="todo TODO">TODO</span> linux-v5.9</a>
<ul>
<li><a href="#org9d1c70f">2.1.1. <span class="todo HOLD">HOLD</span> 注册 watchpoint 之后马上被触发</a></li>
</ul>
</li>
<li><a href="#orgaba59d5">2.2. <span class="done _X_">[X]</span> watchpoint</a></li>
<li><a href="#org3693f04">2.3. <span class="done KILL">KILL</span> netlink</a>
<ul>
<li><a href="#orgfc9ea69">2.3.1. <span class="done DONE">DONE</span> 普通用户权限传递给 netlink kernel</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgcbad749">3. UNDO</a>
<ul>
<li><a href="#org86e3749">3.1. thread</a>
<ul>
<li><a href="#orgbefff7d">3.1.1. option</a></li>
<li><a href="#org178094d">3.1.2. <span class="todo ___">[ ]</span> enable / disable watchpoint domain in context switching</a></li>
<li><a href="#org5b5f78b">3.1.3. <span class="todo ___">[ ]</span> inherit watchpoint domain in fork</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org9515271">4. system call</a>
<ul>
<li>
<ul>
<li><a href="#orgf73bf63">4.0.1. include/linux/syscalls.h</a></li>
<li><a href="#orgc57f5f9">4.0.2. linux/include/uapi/asm-generic/unistd.h</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org21b5678">5. commands</a>
<ul>
<li><a href="#org5bf40bf">5.1. linux cross compile</a></li>
<li><a href="#org233a485">5.2. kgdb</a>
<ul>
<li><a href="#orgf60694a">5.2.1. host side</a></li>
<li><a href="#org992a47a">5.2.2. target side</a></li>
</ul>
</li>
<li><a href="#orgac15f8f">5.3. network</a></li>
</ul>
</li>
<li><a href="#org96322a8">6. <span class="done DONE">DONE</span> USB Serial Debug</a>
<ul>
<li><a href="#org63eaa1b">6.1. <code>[1/1]</code> issue</a>
<ul>
<li><a href="#org8cb8f00">6.1.1. <span class="done DONE">DONE</span> ttyACM 无法输入</a></li>
</ul>
</li>
<li><a href="#org1f8ee57">6.2. 串口调试</a></li>
</ul>
</li>
<li><a href="#orgf50ef03">7. <span class="done DONE">DONE</span> register hw\_breakpoint linux work flow</a>
<ul>
<li><a href="#orgc6cbacf">7.1. <code>linux-5.8/kernel/events/hw_breakpoint.c *register_wide_hw_breakpoint*</code></a></li>
<li><a href="#orgcf5d984">7.2. <code>linux-5.8/kernel/events/core.c *perf_event_create_kernel_counter*</code></a></li>
<li><a href="#orgb931413">7.3. <code>linux-5.8/kernel/events/core.c *perf_event_alloc*</code></a></li>
<li><a href="#org52f5fb8">7.4. <code>*perf_init_event*</code></a></li>
<li><a href="#org06a2606">7.5. hw\_breakpoin info parse</a></li>
<li><a href="#orgbd61b77">7.6. install hw breakpoint</a></li>
</ul>
</li>
<li><a href="#org034481e">8. arch\_hw\_breakpoint struct</a>
<ul>
<li><a href="#orgec565d7">8.1. arch\_hw\_breakpoint</a></li>
</ul>
</li>
<li><a href="#orge234618">9. DBG registers</a>
<ul>
<li><a href="#org00e6321">9.1. DBGBCR&lt;n&gt;_EL1</a></li>
<li><a href="#orga3b3704">9.2. DBGBVR&lt;n&gt;_EL1</a></li>
<li><a href="#org047763a">9.3. DBGWCR&lt;n&gt;_EL1</a></li>
</ul>
</li>
<li><a href="#org013da1a">10. <span class="done DONE">DONE</span> 修改 BCR, BVR 寄存器</a></li>
</ul>
</div>
</div>

<div id="outline-container-org8d2e68d" class="outline-2">
<h2 id="org8d2e68d"><span class="section-number-2">1</span> Prerequisites</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org2a72bc0" class="outline-3">
<h3 id="org2a72bc0"><span class="section-number-3">1.1</span> linux cross platform</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ECBE7B;">sudo</span> apt-get install gcc-aarch64-linux-gnu flex bison
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfd1a5d6" class="outline-3">
<h3 id="orgfd1a5d6"><span class="section-number-3">1.2</span> Bionic-Builder</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ECBE7B;">sudo</span> apt-get install -y ccache python3-pip build-essential kernel-package fakeroot libncurses5-dev libssl-dev gcc <span style="color: #ECBE7B;">git</span> gnupg binfmt-support qemu qemu-user-static debootstrap simg2img
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge5489ea" class="outline-2">
<h2 id="orge5489ea"><span class="section-number-2">2</span> <code>[3/5]</code> BUGS</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org62f673a" class="outline-3">
<h3 id="org62f673a"><span class="section-number-3">2.1</span> <span class="todo TODO">TODO</span> linux-v5.9</h3>
<div class="outline-text-3" id="text-2-1">
</div>
<div id="outline-container-org9d1c70f" class="outline-4">
<h4 id="org9d1c70f"><span class="section-number-4">2.1.1</span> <span class="todo HOLD">HOLD</span> 注册 watchpoint 之后马上被触发</h4>
<div class="outline-text-4" id="text-2-1-1">
<pre class="example">

[   59.904699] ------------[ cut here ]------------
[   59.904713] WARNING: CPU: 5 PID: 0 at kernel/rcu/tree.c:630 rcu_eqs_enter.isra.83+0x84/0x90
[   59.904714] Modules linked in: wl18xx wlcore mac80211 libarc4 cfg80211 rfkill wlcore_sdio crct10dif_ce ip_tables x_tables ipv6
[   59.904730] CPU: 5 PID: 0 Comm: swapper/5 Not tainted 5.9.0-rc7-g48fe30379-dirty #15
[   59.904731] Hardware name: HiKey970 (DT)
[   59.904734] pstate: 200003c5 (nzCv DAIF -PAN -UAO BTYPE=--)
[   59.904736] pc : rcu_eqs_enter.isra.83+0x84/0x90
[   59.904742] lr : rcu_idle_enter+0x10/0x20
[   59.904743] sp : ffff8000100c3f10
[   59.904744] x29: ffff8000100c3f10 x28: 0000000000000000
[   59.904746] x27: ffff0001b810d400 x26: 0000000000000000
[   59.904748] x25: 0000000000000000 x24: ffff800011c3a2c4
[   59.904751] x23: ffff80001181cf38 x22: ffff800011c39000
[   59.904752] x21: ffff800011c3a000 x20: 0000000000000020
[   59.904754] x19: ffff800011c3a1c8 x18: ffffffffffffffff
[   59.904755] x17: 0000000000000000 x16: 0000000000000000
[   59.904757] x15: 0000b2efefd0fc7e x14: 00000000000001a8
[   59.904758] x13: 00000000000001a8 x12: 0000000000000001
[   59.904760] x11: 0000000000000001 x10: 00000000000009c0
[   59.904761] x9 : ffff8000100c3ea0 x8 : ffff0001b810de20
[   59.904764] x7 : 00000000ffffffff x6 : 00000000081ac8c2
[   59.904765] x5 : 00ffffffffffffff x4 : ffff800011e7d000
[   59.904767] x3 : 4000000000000002 x2 : ffff80001181e000
[   59.904768] x1 : 4000000000000000 x0 : ffff0001bf3a1e00
[   59.904771] Call trace:
[   59.904773]  rcu_eqs_enter.isra.83+0x84/0x90
[   59.904776]  rcu_idle_enter+0x10/0x20
[   59.904778]  default_idle_call+0x20/0x50
[   59.904780]  do_idle+0x1e4/0x280
[   59.904782]  cpu_startup_entry+0x24/0x68
[   59.904786]  secondary_start_kernel+0x1ac/0x200
[   59.904788] ---[ end trace 973e77280e8fd726 ]---

</pre>

<p>
__arm64_sys_watchpoint_register_backtrace
<img src="figures/__arm64_sys_watchpoint_register_backtrace.png" alt="__arm64_sys_watchpoint_register_backtrace.png" />
</p>

<p>
trigger_backtrace
<img src="figures/trigger_backtrace.png" alt="trigger_backtrace.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgaba59d5" class="outline-3">
<h3 id="orgaba59d5"><span class="section-number-3">2.2</span> <span class="done _X_">[X]</span> watchpoint</h3>
<div class="outline-text-3" id="text-2-2">
<p>
触发之后无法跳出 trigger function
</p>

<p>
<a href="https://stackoverflow.com/questions/28280813/register-wide-hw-breakpoint-continually-triggers-handler-callback">feature</a>
</p>
</div>
</div>

<div id="outline-container-org3693f04" class="outline-3">
<h3 id="org3693f04"><span class="section-number-3">2.3</span> <span class="done KILL">KILL</span> netlink</h3>
<div class="outline-text-3" id="text-2-3">
</div>
<div id="outline-container-orgfc9ea69" class="outline-4">
<h4 id="orgfc9ea69"><span class="section-number-4">2.3.1</span> <span class="done DONE">DONE</span> 普通用户权限传递给 netlink kernel</h4>
<div class="outline-text-4" id="text-2-3-1">
<p>
普通用户无法注册 watchpoint
sudo 权限可注册
</p>

<ul class="org-ul">
<li>可用于保护 watchpoint 不被恶意使用</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-orgcbad749" class="outline-2">
<h2 id="orgcbad749"><span class="section-number-2">3</span> UNDO</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org86e3749" class="outline-3">
<h3 id="org86e3749"><span class="section-number-3">3.1</span> thread</h3>
<div class="outline-text-3" id="text-3-1">
</div>
<div id="outline-container-orgbefff7d" class="outline-4">
<h4 id="orgbefff7d"><span class="section-number-4">3.1.1</span> option</h4>
<div class="outline-text-4" id="text-3-1-1">
<ul class="org-ul">
<li><del>每个线程自己拥有自己的 breakpoint info, 线程切换时 unregister, register</del>
<ol class="org-ol">
<li>增加可用 watchpoint 数量</li>
<li>overhead</li>
<li>加锁位置?</li>
</ol></li>

<li>所用进程共用 watchpoint, 切换时设置 disable
<ol class="org-ol">
<li>数量有限</li>
<li>效率</li>
</ol></li>
</ul>
</div>
</div>


<div id="outline-container-org178094d" class="outline-4">
<h4 id="org178094d"><span class="section-number-4">3.1.2</span> <span class="todo ___">[ ]</span> enable / disable watchpoint domain in context switching</h4>
<div class="outline-text-4" id="text-3-1-2">
<p>
Update watchpoints.
</p>

<p>
<a href="file:///home/saint/Bionic-Builder/Kernel-SRC/linux-5.8/arch/arm64/kernel/hw_breakpoint.c#MissingReference">file:///home/saint/Bionic-Builder/Kernel-SRC/linux-5.8/arch/arm64/kernel/hw_breakpoint.c#MissingReference</a>
</p>
</div>
</div>

<div id="outline-container-org5b5f78b" class="outline-4">
<h4 id="org5b5f78b"><span class="section-number-4">3.1.3</span> <span class="todo ___">[ ]</span> inherit watchpoint domain in fork</h4>
<div class="outline-text-4" id="text-3-1-3">
<p>
err = arch_dup_task_struct(tsk, orig);
</p>

<p>
<a href="file:///home/saint/Bionic-Builder/Kernel-SRC/linux-5.8/kernel/fork.c#MissingReference">file:///home/saint/Bionic-Builder/Kernel-SRC/linux-5.8/kernel/fork.c#MissingReference</a>
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org9515271" class="outline-2">
<h2 id="org9515271"><span class="section-number-2">4</span> system call</h2>
<div class="outline-text-2" id="text-4">
<p>
<a href="https://www.kernel.org/doc/html/latest/process/adding-syscalls.html">system call linux kernel docs</a>
</p>
</div>

<div id="outline-container-orgf73bf63" class="outline-4">
<h4 id="orgf73bf63"><span class="section-number-4">4.0.1</span> include/linux/syscalls.h</h4>
<div class="outline-text-4" id="text-4-0-1">
<div class="org-src-container">
<pre class="src src-c">asmlinkage <span style="color: #ECBE7B;">long</span> <span style="color: #c678dd;">__arm64_sys_register_watchpoint</span><span style="color: #51afef;">(</span><span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">long</span> <span style="color: #dcaeea;">addr</span><span style="color: #51afef;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc57f5f9" class="outline-4">
<h4 id="orgc57f5f9"><span class="section-number-4">4.0.2</span> linux/include/uapi/asm-generic/unistd.h</h4>
<div class="outline-text-4" id="text-4-0-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #51afef; font-weight: bold;">#ifdef</span> <span style="color: #a9a1e1;">CONFIG_AWID</span>
<span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">__NR_register_watchpoint</span> <span style="color: #da8548; font-weight: bold;">440</span>                                                                                                                                               
<span style="color: #c678dd;">__SYSCALL</span><span style="color: #51afef;">(</span>__NR_register_watchpoint, sys_register_watchpoint<span style="color: #51afef;">)</span>                                                                                                                       
<span style="color: #51afef; font-weight: bold;">#endif</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org21b5678" class="outline-2">
<h2 id="org21b5678"><span class="section-number-2">5</span> commands</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org5bf40bf" class="outline-3">
<h3 id="org5bf40bf"><span class="section-number-3">5.1</span> linux cross compile</h3>
<div class="outline-text-3" id="text-5-1">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ECBE7B;">sudo</span> <span style="color: #ECBE7B;">make</span> -j20 <span style="color: #dcaeea;">ARCH</span>=arm64 <span style="color: #dcaeea;">CROSS_COMPILE</span>=aarch64-linux-gnu- hikey970_defconfig
<span style="color: #ECBE7B;">sudo</span> <span style="color: #ECBE7B;">make</span> -j20 <span style="color: #dcaeea;">ARCH</span>=arm64 <span style="color: #dcaeea;">CROSS_COMPILE</span>=aarch64-linux-gnu- all
</pre>
</div>
</div>
</div>
<div id="outline-container-org233a485" class="outline-3">
<h3 id="org233a485"><span class="section-number-3">5.2</span> kgdb</h3>
<div class="outline-text-3" id="text-5-2">
</div>
<div id="outline-container-orgf60694a" class="outline-4">
<h4 id="orgf60694a"><span class="section-number-4">5.2.1</span> host side</h4>
<div class="outline-text-4" id="text-5-2-1">
<div class="org-src-container">
<pre class="src src-bash">aarch64-linux-gnu-gdb vmlinux -ex <span style="color: #98be65;">"set serial baud 115200"</span>

target remote /dev/ttyXRUSB0
</pre>
</div>
</div>
</div>

<div id="outline-container-org992a47a" class="outline-4">
<h4 id="org992a47a"><span class="section-number-4">5.2.2</span> target side</h4>
<div class="outline-text-4" id="text-5-2-2">
<pre class="example">
sudo echo g &gt; /proc/sysrq-trigger
</pre>
</div>
</div>
</div>


<div id="outline-container-orgac15f8f" class="outline-3">
<h3 id="orgac15f8f"><span class="section-number-3">5.3</span> network</h3>
<div class="outline-text-3" id="text-5-3">
<ul class="org-ul">
<li><p>
connect wifi from terminal
</p>

<div class="org-src-container">
<pre class="src src-bash">  <span style="color: #ECBE7B;">sudo</span> nmcli dev wifi connect <span style="color: #98be65;">'SSID'</span>
</pre>
</div></li>

<li><p>
control
</p>
<div class="org-src-container">
<pre class="src src-bash"> <span style="color: #ECBE7B;">sudo</span> nmcli
</pre>
</div></li>
</ul>
</div>
</div>
</div>


<div id="outline-container-org96322a8" class="outline-2">
<h2 id="org96322a8"><span class="section-number-2">6</span> <span class="done DONE">DONE</span> USB Serial Debug</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-org63eaa1b" class="outline-3">
<h3 id="org63eaa1b"><span class="section-number-3">6.1</span> <code>[1/1]</code> issue</h3>
<div class="outline-text-3" id="text-6-1">
</div>
<div id="outline-container-org8cb8f00" class="outline-4">
<h4 id="org8cb8f00"><span class="section-number-4">6.1.1</span> <span class="done DONE">DONE</span> ttyACM 无法输入</h4>
<div class="outline-text-4" id="text-6-1-1">
<p>
<a href="https://discuss.96boards.org/t/how-to-connect-to-console-in-hikey970-in-android/5484/10">XR21V1410 USB-UART</a>
</p>

<blockquote>
<p>
Hikey970 uses XR21B14 chip for the USB-C debug serial port. The driver for this chip is not available in upstream linux kernel but since it supports part of USB CDC class, it does appear as ttyACM0 port. But this chip uses custom flow control modes which can’t be supported by usb cdc driver and flow control is needed for input. That’s why you can’t type anything onto the default ttyACM0 console but you can see the output.
</p>

<p>
Coming to your question on some people got it working fully, that is mainly due to the packaging of specific driver for this chip in the distro version. For instance, Ubuntu 18.04 has this driver enabled, so users who have this specific distro will be able to use it without any issues. They will have the console as ttyXRUSB0 instead of ttyACM0.
</p>

<p>
So if you need to use this port, please build the driver(just google xr21b14 driver, you’ll find it) and load onto your PC.
</p>
</blockquote>


<p>
<a href="https://www.maxlinear.com/support/design-tools/software-drivers">XR21V1410 Driver</a>
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ECBE7B;">sudo</span> rmmod cdc_acm
<span style="color: #ECBE7B;">sudo</span> insmod xr_sub_serial_common.ko
</pre>
</div>

<p>
重新插拔 Type-C USB, hikey970 被识别为 <code>ttyXRUSB</code>
</p>
</div>
</div>
</div>

<div id="outline-container-org1f8ee57" class="outline-3">
<h3 id="org1f8ee57"><span class="section-number-3">6.2</span> 串口调试</h3>
<div class="outline-text-3" id="text-6-2">
<ul class="org-ul">
<li>minicom 115200 8N1</li>
<li><b>hardware / software flow control: No</b></li>
</ul>
</div>
</div>
</div>


<div id="outline-container-orgf50ef03" class="outline-2">
<h2 id="orgf50ef03"><span class="section-number-2">7</span> <span class="done DONE">DONE</span> register hw\_breakpoint linux work flow</h2>
<div class="outline-text-2" id="text-7">
</div>

<div id="outline-container-orgc6cbacf" class="outline-3">
<h3 id="orgc6cbacf"><span class="section-number-3">7.1</span> <code>linux-5.8/kernel/events/hw_breakpoint.c *register_wide_hw_breakpoint*</code></h3>
<div class="outline-text-3" id="text-7-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #83898d;">/**</span>
<span style="color: #83898d;"> * register_wide_hw_breakpoint - register a wide breakpoint in the kernel</span>
<span style="color: #83898d;"> * </span><span style="color: #a9a1e1;">@attr</span><span style="color: #83898d;">: breakpoint attributes</span>
<span style="color: #83898d;"> * </span><span style="color: #a9a1e1;">@triggered</span><span style="color: #83898d;">: callback to trigger when we hit the breakpoint</span>
<span style="color: #83898d;"> *</span>
<span style="color: #83898d;"> * </span><span style="color: #a9a1e1;">@return</span><span style="color: #83898d;"> a set of per_cpu pointers to perf events</span>
<span style="color: #83898d;"> */</span>

<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> * <span style="color: #c678dd;">__percpu</span> *
register_wide_hw_breakpoint<span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event_attr</span> *<span style="color: #dcaeea;">attr</span>,
                <span style="color: #ECBE7B;">perf_overflow_handler_t</span> <span style="color: #dcaeea;">triggered</span>,
                <span style="color: #ECBE7B;">void</span> *<span style="color: #dcaeea;">context</span><span style="color: #51afef;">)</span>;

...<span style="color: #da8548; font-weight: bold;">571</span>
        bp = perf_event_create_kernel_counter<span style="color: #51afef;">(</span>attr, cpu, <span style="color: #a9a1e1;">NULL</span>,
                              triggered, context<span style="color: #51afef;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcf5d984" class="outline-3">
<h3 id="orgcf5d984"><span class="section-number-3">7.2</span> <code>linux-5.8/kernel/events/core.c *perf_event_create_kernel_counter*</code></h3>
<div class="outline-text-3" id="text-7-2">
<div class="org-src-container">
<pre class="src src-c"> <span style="color: #83898d;">/**</span>
<span style="color: #83898d;"> * perf_event_create_kernel_counter</span>
<span style="color: #83898d;"> *</span>
<span style="color: #83898d;"> * </span><span style="color: #a9a1e1;">@attr</span><span style="color: #83898d;">: attributes of the counter to create</span>
<span style="color: #83898d;"> * </span><span style="color: #a9a1e1;">@cpu</span><span style="color: #83898d;">: cpu in which the counter is bound</span>
<span style="color: #83898d;"> * </span><span style="color: #a9a1e1;">@task</span><span style="color: #83898d;">: task to profile (NULL for percpu)</span>
<span style="color: #83898d;"> */</span>
<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *
<span style="color: #c678dd;">perf_event_create_kernel_counter</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event_attr</span> *<span style="color: #dcaeea;">attr</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">cpu</span>,
                 <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">task_struct</span> *<span style="color: #dcaeea;">task</span>,
                 <span style="color: #ECBE7B;">perf_overflow_handler_t</span> <span style="color: #dcaeea;">overflow_handler</span>,
                 <span style="color: #ECBE7B;">void</span> *<span style="color: #dcaeea;">context</span><span style="color: #51afef;">)</span>;
...<span style="color: #da8548; font-weight: bold;">11952</span>
    event = perf_event_alloc<span style="color: #51afef;">(</span>attr, cpu, task, <span style="color: #a9a1e1;">NULL</span>, <span style="color: #a9a1e1;">NULL</span>,
                 overflow_handler, context, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb931413" class="outline-3">
<h3 id="orgb931413"><span class="section-number-3">7.3</span> <code>linux-5.8/kernel/events/core.c *perf_event_alloc*</code></h3>
<div class="outline-text-3" id="text-7-3">
<div class="org-src-container">
<pre class="src src-c"> <span style="color: #5B6268;">/*</span>
<span style="color: #5B6268;"> * Allocate and initialize an event structure</span>
<span style="color: #5B6268;"> </span><span style="color: #5B6268;">*/</span>
<span style="color: #51afef;">static</span> <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *
<span style="color: #c678dd;">perf_event_alloc</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event_attr</span> *<span style="color: #dcaeea;">attr</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">cpu</span>,
                 <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">task_struct</span> *<span style="color: #dcaeea;">task</span>,
                 <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *<span style="color: #dcaeea;">group_leader</span>,
                 <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *<span style="color: #dcaeea;">parent_event</span>,
                 <span style="color: #ECBE7B;">perf_overflow_handler_t</span> <span style="color: #dcaeea;">overflow_handler</span>,
                 <span style="color: #ECBE7B;">void</span> *<span style="color: #dcaeea;">context</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">cgroup_fd</span><span style="color: #51afef;">)</span>

...<span style="color: #da8548; font-weight: bold;">11035</span>
    event-&gt;cpu      = cpu;
    event-&gt;attr     = *attr;
    event-&gt;group_leader = group_leader;
    event-&gt;pmu      = <span style="color: #a9a1e1;">NULL</span>;
    event-&gt;oncpu        = -<span style="color: #da8548; font-weight: bold;">1</span>;

    event-&gt;parent       = parent_event;

    event-&gt;ns       = get_pid_ns<span style="color: #51afef;">(</span>task_active_pid_ns<span style="color: #c678dd;">(</span>current<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>;
    event-&gt;id       = atomic64_inc_return<span style="color: #51afef;">(</span>&amp;perf_event_id<span style="color: #51afef;">)</span>;

...<span style="color: #da8548; font-weight: bold;">11110</span>
    pmu = perf_init_event<span style="color: #51afef;">(</span>event<span style="color: #51afef;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org52f5fb8" class="outline-3">
<h3 id="org52f5fb8"><span class="section-number-3">7.4</span> <code>*perf_init_event*</code></h3>
<div class="outline-text-3" id="text-7-4">
<ul class="org-ul">
<li>perf\_init\_event</li>
</ul>

<div class="org-src-container">
<pre class="src src-c">
<span style="color: #51afef;">static</span> <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">pmu</span> *<span style="color: #c678dd;">perf_init_event</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *<span style="color: #dcaeea;">event</span><span style="color: #51afef;">)</span>
        ret = perf_try_init_event<span style="color: #51afef;">(</span>pmu, event<span style="color: #51afef;">)</span>;
</pre>
</div>

<p>
call <code>*pmu.event_init(event)*</code>
</p>

<p>
&#x2026;
</p>

<ul class="org-ul">
<li><code>linux-5.8/kernel/events/hw_breakpoint.c</code></li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #51afef;">static</span> <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">pmu</span> <span style="color: #dcaeea;">perf_breakpoint</span> = <span style="color: #51afef;">{</span>
    .task_ctx_nr    = perf_sw_context, <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">could eventually get its own </span><span style="color: #5B6268;">*/</span>

    .event_init = hw_breakpoint_event_init,
    .add            = hw_breakpoint_add,
    .del            = hw_breakpoint_del,
    .start      = hw_breakpoint_start,
    .stop       = hw_breakpoint_stop,
    .read       = hw_breakpoint_pmu_read,
<span style="color: #51afef;">}</span>;

</pre>
</div>

<ul class="org-ul">
<li><code>*hw_breakpoint_event_init*</code></li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #51afef;">static</span> <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">hw_breakpoint_event_init</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *<span style="color: #dcaeea;">bp</span><span style="color: #51afef;">)</span>
<span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">err</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>bp-&gt;attr.type != <span style="color: #a9a1e1;">PERF_TYPE_BREAKPOINT</span><span style="color: #c678dd;">)</span>
        <span style="color: #51afef;">return</span> -<span style="color: #a9a1e1;">ENOENT</span>;

    <span style="color: #5B6268;">/*</span>
<span style="color: #5B6268;">     * no branch sampling for breakpoint events</span>
<span style="color: #5B6268;">     </span><span style="color: #5B6268;">*/</span>
    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>has_branch_stack<span style="color: #98be65;">(</span>bp<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>
        <span style="color: #51afef;">return</span> -<span style="color: #a9a1e1;">EOPNOTSUPP</span>;

    err = register_perf_hw_breakpoint<span style="color: #c678dd;">(</span>bp<span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>err<span style="color: #c678dd;">)</span>
        <span style="color: #51afef;">return</span> err;

    bp-&gt;destroy = bp_perf_event_destroy;

    <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #51afef;">}</span>
</pre>
</div>

<ul class="org-ul">
<li><code>*register_perf_hw_breakpoint*</code></li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">register_perf_hw_breakpoint</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *<span style="color: #dcaeea;">bp</span><span style="color: #51afef;">)</span>
<span style="color: #51afef;">{</span>
    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">arch_hw_breakpoint</span> <span style="color: #dcaeea;">hw</span> = <span style="color: #c678dd;">{</span> <span style="color: #c678dd;">}</span>;
    <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">err</span>;

    err = reserve_bp_slot<span style="color: #c678dd;">(</span>bp<span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>err<span style="color: #c678dd;">)</span>
        <span style="color: #51afef;">return</span> err;

    err = hw_breakpoint_parse<span style="color: #c678dd;">(</span>bp, &amp;bp-&gt;attr, &amp;hw<span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>err<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
        release_bp_slot<span style="color: #98be65;">(</span>bp<span style="color: #98be65;">)</span>;
        <span style="color: #51afef;">return</span> err;
    <span style="color: #c678dd;">}</span>

    bp-&gt;hw.info = hw;

    <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #51afef;">}</span>
</pre>
</div>

<p>
reserve / release 加锁
</p>

<ul class="org-ul">
<li><code>*hw_breakpoint_parse*</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #51afef;">static</span> <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">hw_breakpoint_parse</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *<span style="color: #dcaeea;">bp</span>,
                   <span style="color: #51afef;">const</span> <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event_attr</span> *<span style="color: #dcaeea;">attr</span>,
                   <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">arch_hw_breakpoint</span> *<span style="color: #dcaeea;">hw</span><span style="color: #51afef;">)</span>
<span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">err</span>;

    err = hw_breakpoint_arch_parse<span style="color: #c678dd;">(</span>bp, attr, hw<span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>err<span style="color: #c678dd;">)</span>
        <span style="color: #51afef;">return</span> err;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>arch_check_bp_in_kernelspace<span style="color: #98be65;">(</span>hw<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
        <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>attr-&gt;exclude_kernel<span style="color: #98be65;">)</span>
            <span style="color: #51afef;">return</span> -<span style="color: #a9a1e1;">EINVAL</span>;
        <span style="color: #5B6268;">/*</span>
<span style="color: #5B6268;">         * Don't let unprivileged users set a breakpoint in the trap</span>
<span style="color: #5B6268;">         * path to avoid trap recursion attacks.</span>
<span style="color: #5B6268;">         </span><span style="color: #5B6268;">*/</span>
        <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span><span style="color: #51afef; font-weight: bold;">!</span>capable<span style="color: #51afef;">(</span><span style="color: #a9a1e1;">CAP_SYS_ADMIN</span><span style="color: #51afef;">)</span><span style="color: #98be65;">)</span>
            <span style="color: #51afef;">return</span> -<span style="color: #a9a1e1;">EPERM</span>;
    <span style="color: #c678dd;">}</span>

    <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #51afef;">}</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
<code>*hw_breakpoint_arch_parse*</code>
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #5B6268;">/*</span>
<span style="color: #5B6268;"> * Validate the arch-specific HW Breakpoint register settings.</span>
<span style="color: #5B6268;"> </span><span style="color: #5B6268;">*/</span>
<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">hw_breakpoint_arch_parse</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *<span style="color: #dcaeea;">bp</span>,
                 <span style="color: #51afef;">const</span> <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event_attr</span> *<span style="color: #dcaeea;">attr</span>,
                 <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">arch_hw_breakpoint</span> *<span style="color: #dcaeea;">hw</span><span style="color: #51afef;">)</span>
<span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">ret</span>;
    <span style="color: #ECBE7B;">u64</span> <span style="color: #dcaeea;">alignment_mask</span>, <span style="color: #dcaeea;">offset</span>;

    <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Build the arch_hw_breakpoint. </span><span style="color: #5B6268;">*/</span>
    ret = arch_build_bp_info<span style="color: #c678dd;">(</span>bp, attr, hw<span style="color: #c678dd;">)</span>;
...
<span style="color: #51afef;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org06a2606" class="outline-3">
<h3 id="org06a2606"><span class="section-number-3">7.5</span> hw\_breakpoin info parse</h3>
<div class="outline-text-3" id="text-7-5">
<ul class="org-ul">
<li><p>
<code>arch_build_bp_info</code>
</p>

<p>
解析 <code>perf_even-&gt;hw-&gt;info</code>
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgbd61b77" class="outline-3">
<h3 id="orgbd61b77"><span class="section-number-3">7.6</span> install hw breakpoint</h3>
<div class="outline-text-3" id="text-7-6">
<ul class="org-ul">
<li><code>*hw_breakpoint_add*</code></li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #51afef;">static</span> <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">hw_breakpoint_add</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *<span style="color: #dcaeea;">bp</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">flags</span><span style="color: #51afef;">)</span>
<span style="color: #51afef;">{</span>
    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span><span style="color: #51afef; font-weight: bold;">!</span><span style="color: #98be65;">(</span>flags &amp; <span style="color: #a9a1e1;">PERF_EF_START</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>
        bp-&gt;hw.state = <span style="color: #a9a1e1;">PERF_HES_STOPPED</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>is_sampling_event<span style="color: #98be65;">(</span>bp<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
        bp-&gt;hw.last_period = bp-&gt;hw.sample_period;
        perf_swevent_set_period<span style="color: #98be65;">(</span>bp<span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>

    <span style="color: #51afef;">return</span> arch_install_hw_breakpoint<span style="color: #c678dd;">(</span>bp<span style="color: #c678dd;">)</span>;
<span style="color: #51afef;">}</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
<code>linux-5.8/arch/arm64/kernel/hw_breakpoint.c *arch_install_hw_breakpoint*</code>
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #5B6268;">/*</span>
<span style="color: #5B6268;"> * Install a perf counter breakpoint.</span>
<span style="color: #5B6268;"> </span><span style="color: #5B6268;">*/</span>
<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">arch_install_hw_breakpoint</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *<span style="color: #dcaeea;">bp</span><span style="color: #51afef;">)</span>
<span style="color: #51afef;">{</span>
    <span style="color: #51afef;">return</span> hw_breakpoint_control<span style="color: #c678dd;">(</span>bp, <span style="color: #a9a1e1;">HW_BREAKPOINT_INSTALL</span><span style="color: #c678dd;">)</span>;
<span style="color: #51afef;">}</span>

</pre>
</div></li>

<li><code>linux-5.8/arch/arm64/kernel/hw_breakpoint.c *hw_breakpoint_control*</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #51afef;">static</span> <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">hw_breakpoint_control</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> *<span style="color: #dcaeea;">bp</span>,
                 <span style="color: #51afef;">enum</span> <span style="color: #ECBE7B;">hw_breakpoint_ops</span> <span style="color: #dcaeea;">ops</span><span style="color: #51afef;">)</span>
<span style="color: #51afef;">{</span>
    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">arch_hw_breakpoint</span> *<span style="color: #dcaeea;">info</span> = counter_arch_bp<span style="color: #c678dd;">(</span>bp<span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">perf_event</span> **<span style="color: #dcaeea;">slots</span>;
    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">debug_info</span> *<span style="color: #dcaeea;">debug_info</span> = &amp;current-&gt;thread.debug;
    <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span>, <span style="color: #dcaeea;">max_slots</span>, <span style="color: #dcaeea;">ctrl_reg</span>, <span style="color: #dcaeea;">val_reg</span>, <span style="color: #dcaeea;">reg_enable</span>;
    <span style="color: #51afef;">enum</span> <span style="color: #ECBE7B;">dbg_active_el</span> <span style="color: #dcaeea;">dbg_el</span> = debug_exception_level<span style="color: #c678dd;">(</span>info-&gt;ctrl.privilege<span style="color: #c678dd;">)</span>;
    <span style="color: #ECBE7B;">u32</span> <span style="color: #dcaeea;">ctrl</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>info-&gt;ctrl.type == <span style="color: #a9a1e1;">ARM_BREAKPOINT_EXECUTE</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
        <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Breakpoint </span><span style="color: #5B6268;">*/</span>
        ctrl_reg = AARCH64_DBG_REG_BCR;
        val_reg = AARCH64_DBG_REG_BVR;
        slots = this_cpu_ptr<span style="color: #98be65;">(</span>bp_on_reg<span style="color: #98be65;">)</span>;
        max_slots = core_num_brps;
        reg_enable = <span style="color: #51afef; font-weight: bold;">!</span>debug_info-&gt;bps_disabled;
    <span style="color: #c678dd;">}</span> <span style="color: #51afef;">else</span> <span style="color: #c678dd;">{</span>
        <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Watchpoint </span><span style="color: #5B6268;">*/</span>
        ctrl_reg = AARCH64_DBG_REG_WCR;
        val_reg = AARCH64_DBG_REG_WVR;
        slots = this_cpu_ptr<span style="color: #98be65;">(</span>wp_on_reg<span style="color: #98be65;">)</span>;
        max_slots = core_num_wrps;
        reg_enable = <span style="color: #51afef; font-weight: bold;">!</span>debug_info-&gt;wps_disabled;
    <span style="color: #c678dd;">}</span>

    i = hw_breakpoint_slot_setup<span style="color: #c678dd;">(</span>slots, max_slots, bp, ops<span style="color: #c678dd;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span><span style="color: #a9a1e1;">WARN_ONCE</span><span style="color: #98be65;">(</span>i &lt; <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #98be65;">"Can't find any breakpoint slot"</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>
        <span style="color: #51afef;">return</span> i;

    <span style="color: #51afef;">switch</span> <span style="color: #c678dd;">(</span>ops<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">case</span> <span style="color: #a9a1e1;">HW_BREAKPOINT_INSTALL</span>:
        <span style="color: #5B6268;">/*</span>
<span style="color: #5B6268;">         * Ensure debug monitors are enabled at the correct exception</span>
<span style="color: #5B6268;">         * level.</span>
<span style="color: #5B6268;">         </span><span style="color: #5B6268;">*/</span>
        enable_debug_monitors<span style="color: #98be65;">(</span>dbg_el<span style="color: #98be65;">)</span>;
        fallthrough;
    <span style="color: #51afef;">case</span> <span style="color: #a9a1e1;">HW_BREAKPOINT_RESTORE</span>:
        <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Setup the address register. </span><span style="color: #5B6268;">*/</span>
        write_wb_reg<span style="color: #98be65;">(</span>val_reg, i, info-&gt;address<span style="color: #98be65;">)</span>;

        <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Setup the control register. </span><span style="color: #5B6268;">*/</span>
        ctrl = encode_ctrl_reg<span style="color: #98be65;">(</span>info-&gt;ctrl<span style="color: #98be65;">)</span>;
        write_wb_reg<span style="color: #98be65;">(</span>ctrl_reg, i,
                 reg_enable ? ctrl | <span style="color: #da8548; font-weight: bold;">0x1</span> : ctrl &amp; ~<span style="color: #da8548; font-weight: bold;">0x1</span><span style="color: #98be65;">)</span>;
        <span style="color: #51afef;">break</span>;
    <span style="color: #51afef;">case</span> <span style="color: #a9a1e1;">HW_BREAKPOINT_UNINSTALL</span>:
        <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Reset the control register. </span><span style="color: #5B6268;">*/</span>
        write_wb_reg<span style="color: #98be65;">(</span>ctrl_reg, i, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">)</span>;

        <span style="color: #5B6268;">/*</span>
<span style="color: #5B6268;">         * Release the debug monitors for the correct exception</span>
<span style="color: #5B6268;">         * level.</span>
<span style="color: #5B6268;">         </span><span style="color: #5B6268;">*/</span>
        disable_debug_monitors<span style="color: #98be65;">(</span>dbg_el<span style="color: #98be65;">)</span>;
        <span style="color: #51afef;">break</span>;
    <span style="color: #c678dd;">}</span>

    <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #51afef;">}</span>
</pre>
</div>
</div>
</div>
</div>



<div id="outline-container-org034481e" class="outline-2">
<h2 id="org034481e"><span class="section-number-2">8</span> arch\_hw\_breakpoint struct</h2>
<div class="outline-text-2" id="text-8">
</div>
<div id="outline-container-orgec565d7" class="outline-3">
<h3 id="orgec565d7"><span class="section-number-3">8.1</span> arch\_hw\_breakpoint</h3>
<div class="outline-text-3" id="text-8-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">hw_perf_event</span> <span style="color: #51afef;">{</span>
    ...;
    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">hw_perf_event</span>        <span style="color: #dcaeea;">hw</span>;
    ...;
<span style="color: #51afef;">}</span>

<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">hw_petf_event</span><span style="color: #51afef;">{</span>
    ...;
    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">arch_hw_breakpoint</span> <span style="color: #dcaeea;">info</span>;
    ...;
<span style="color: #51afef;">}</span>

<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">arch_hw_breakpoint</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">u64</span> <span style="color: #dcaeea;">address</span>;
    <span style="color: #ECBE7B;">u64</span> <span style="color: #dcaeea;">trigger</span>;
    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">arch_hw_breakpoint_ctrl</span> <span style="color: #dcaeea;">ctrl</span>;
<span style="color: #51afef;">}</span>;

<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">arch_hw_breakpoint_ctrl</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">u32</span> <span style="color: #dcaeea;">__reserved</span>  : <span style="color: #da8548; font-weight: bold;">19</span>,
    <span style="color: #dcaeea;">len</span>     : <span style="color: #da8548; font-weight: bold;">8</span>,
    <span style="color: #dcaeea;">type</span>        : <span style="color: #da8548; font-weight: bold;">2</span>,
    <span style="color: #dcaeea;">privilege</span>   : <span style="color: #da8548; font-weight: bold;">2</span>,
    <span style="color: #dcaeea;">enabled</span>     : <span style="color: #da8548; font-weight: bold;">1</span>;
<span style="color: #51afef;">}</span>;
</pre>
</div>

<p>
arch\_hw\_breakpoint-&gt;ctrl 位域实现 DBGWCR
</p>
</div>
</div>
</div>

<div id="outline-container-orge234618" class="outline-2">
<h2 id="orge234618"><span class="section-number-2">9</span> DBG registers</h2>
<div class="outline-text-2" id="text-9">
</div>
<div id="outline-container-org00e6321" class="outline-3">
<h3 id="org00e6321"><span class="section-number-3">9.1</span> DBGBCR&lt;n&gt;_EL1</h3>
<div class="outline-text-3" id="text-9-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">bits [63:24]</th>
<th scope="col" class="org-left">BT, bits [23:20]</th>
<th scope="col" class="org-left">LBN, bits [19:16]</th>
<th scope="col" class="org-left">SSC, bits [15:14]</th>
<th scope="col" class="org-left">HMC, bit [13]</th>
<th scope="col" class="org-left">Bits [12:9]</th>
<th scope="col" class="org-left">BAS, bits [8:5]</th>
<th scope="col" class="org-left">Bits [4:3]</th>
<th scope="col" class="org-left">PMC, bits [2:1]</th>
<th scope="col" class="org-left">E, bit [0]</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Reserved</td>
<td class="org-left">Breakpoint Type</td>
<td class="org-left">Linked breakpoint number</td>
<td class="org-left">Security state control</td>
<td class="org-left">Higher mode control.</td>
<td class="org-left">Reserved</td>
<td class="org-left">Byte address select.</td>
<td class="org-left">Reserved</td>
<td class="org-left">Privilege mode control</td>
<td class="org-left">Enable breakpoint</td>
</tr>
</tbody>
</table>

<p>
DBGBCR&lt;n&gt;_EL1.BT shoulde be 0b000x
</p>
</div>
</div>
<div id="outline-container-orga3b3704" class="outline-3">
<h3 id="orga3b3704"><span class="section-number-3">9.2</span> DBGBVR&lt;n&gt;_EL1</h3>
<div class="outline-text-3" id="text-9-2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">RESS[14:4], bits [63:53]</th>
<th scope="col" class="org-left">VA[52:49], bits [52:49]</th>
<th scope="col" class="org-left">VA[48:2], bits [48:2]</th>
<th scope="col" class="org-left">Bits [1:0]</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Reserved</td>
<td class="org-left">Extension to VA[48:2]</td>
<td class="org-left">the address value for comparison</td>
<td class="org-left">Reserved</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org047763a" class="outline-3">
<h3 id="org047763a"><span class="section-number-3">9.3</span> DBGWCR&lt;n&gt;_EL1</h3>
<div class="outline-text-3" id="text-9-3">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Bits [63:29]</th>
<th scope="col" class="org-left">Bits [23:21]</th>
<th scope="col" class="org-left">WT, bit [20]</th>
<th scope="col" class="org-left">LBN, bits [19:16]</th>
<th scope="col" class="org-left">SSC, bits [15:14]</th>
<th scope="col" class="org-left">HMC, bit [13]</th>
<th scope="col" class="org-left">BAS, bits [12:5]</th>
<th scope="col" class="org-left">LSC, bits [4:3]</th>
<th scope="col" class="org-left">PAC, bits [2:1]</th>
<th scope="col" class="org-left">E, bit [0]</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Reserved</td>
<td class="org-left">Reserved</td>
<td class="org-left">Address mask</td>
<td class="org-left">Linked breakpoint number</td>
<td class="org-left">Security state control</td>
<td class="org-left">Higher mode control</td>
<td class="org-left">Byte address select</td>
<td class="org-left">Load/store control</td>
<td class="org-left">Privilege of access control</td>
<td class="org-left">Enable</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><code>linked data address</code>
在特定 <code>context</code> 触发</li>

<li>WT
0b0 unlinked data address</li>

<li>LBN
0b0000</li>

<li>SSC</li>

<li>HMC</li>

<li>BAS</li>

<li>LSC
save load control</li>
</ul>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">LSC</td>
<td class="org-left">Meaning</td>
</tr>

<tr>
<td class="org-left">0b01</td>
<td class="org-left">Match           instructions that load from a watchpointed address.</td>
</tr>

<tr>
<td class="org-left">0b10</td>
<td class="org-left">Match           instructions that store to a watchpointed address.</td>
</tr>

<tr>
<td class="org-left">0b11</td>
<td class="org-left">Match           instructions that load from or store to a watchpointed address.</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>PAC</li>

<li>E
0 disabled
1 enabled</li>
</ul>
</div>
</div>
</div>


<div id="outline-container-org013da1a" class="outline-2">
<h2 id="org013da1a"><span class="section-number-2">10</span> <span class="done DONE">DONE</span> 修改 BCR, BVR 寄存器</h2>
<div class="outline-text-2" id="text-10">
<ul class="org-ul">
<li>ref <a href="https://developer.arm.com/docs/ddi0595/h/aarch64-system-registers/dbgbcrn_el1">DBGBCR</a></li>

<li><p>
code
</p>
<div class="org-src-container">
<pre class="src src-c">    <span style="color: #51afef;">case</span> <span style="color: #a9a1e1;">HW_BREAKPOINT_RESTORE</span>:
        <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Setup the address register. </span><span style="color: #5B6268;">*/</span>
        <span style="color: #c678dd;">write_wb_reg</span><span style="color: #51afef;">(</span>val_reg, i, info-&gt;address<span style="color: #51afef;">)</span>;

        <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Setup the control register. </span><span style="color: #5B6268;">*/</span>
        ctrl = encode_ctrl_reg<span style="color: #51afef;">(</span>info-&gt;ctrl<span style="color: #51afef;">)</span>;
        <span style="color: #c678dd;">write_wb_reg</span><span style="color: #51afef;">(</span>ctrl_reg, i,
                 reg_enable ? ctrl | <span style="color: #da8548; font-weight: bold;">0x1</span> : ctrl &amp; ~<span style="color: #da8548; font-weight: bold;">0x1</span><span style="color: #51afef;">)</span>;
        <span style="color: #51afef;">break</span>;
</pre>
</div></li>
</ul>
<p>
[[<a href="file:///home/saint/Bionic-Builder/Kernel-SRC/linux/arch/arm64/kernel/hw_breakpoint.c#MissingReference">file:///home/saint/Bionic-Builder/Kernel-SRC/linux/arch/arm64/kernel/hw_breakpoint.c#MissingReference</a> HW_BREAKPOINT_RESTORE:
</p>

<p>
<a href="#org06a2606">hw\_breakpoin info parse</a>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: ST-Saint</p>
<p class="date">Created: 2020-10-17 Sat 13:00</p>
</div>
</body>
</html>
